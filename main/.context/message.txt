Perfect. Hereâ€™s a decisive, eightâ€‘hour plan to get **AR Collections Agent** demoâ€‘ready with one invoice moving **Overdue â†’ Paid** live in under 90 seconds, while clearly signaling **job replacement**, **MCP tool use**, **reactive state**, and **determinism/safety**.

Iâ€™ll keep this at the level of **planning, flow, responsibilities, milestones, and runâ€‘ofâ€‘show**â€”no code or schemas yet.

---

## North Star (what the judges will remember)

* **â€œInbox â†’ Cash.â€** In 90 seconds: call + email + payment link + state flips to **Paid** with a full audit trail.
* **â€œThis replaces an AR clerkâ€™s weekly chase.â€** Say it verbatim.
* **Sponsor alignment on screen:** Vapi (voice), AgentMail (agent inbox), Autumnâ†’Stripe link (test mode), Convex (reactive state + transactional updates), MCP trace visible. Browser automation/Kernel optional flex.
* **Determinism & safety:** Allowedâ€‘tools list, guardrails, transactional Convex mutations, replayable trace.

---

## Scope boundaries for tonight (MVP)

* **Exact outcome:** 1 overdue invoice â†’ **PaidFull**. (Have **PaidPartial** and **PromiseToPay** as â€œBâ€‘sidesâ€ if network/payment latency spikes.)
* **Channels:** Voice (Vapi) + Email (AgentMail).
* **Payments:** Autumn in Stripe test mode. No real money, no live PII.
* **Data:** Tiny seeded dataset (3 customers; weâ€™ll use one for the live run).
* **Negotiation:** Treated as **tiny state machine** (youâ€™ve got this handled). We wire it to tool calls; no freeâ€‘chat on stage.
* **Auth:** No OAuth. All identities are agentâ€‘owned (AgentMail inbox, Vapi number). Payment link in Stripe test mode.
* **No orchestrator:** Single capable agent invoking MCP tools against a deterministic backend.

---

## System at a glance (what weâ€™ll demo without showing code)

**Views:**

1. **Overdue Board**: counters (â€œOverdue / Inâ€‘Progress / Paidâ€), list of customers/invoices.
2. **Run Panel (right side)**: live **Trace** (MCP tool calls + parameters), **Guardrails** (allowed tools), **State** (current state with green ticks), **Audit** button (full JSON trace).
3. **Inbox Panel** (AgentMail) showing the outbound email with payment link.

**Backâ€‘ofâ€‘house (quietly running):**

* **Convex**: single source of truth; every state transition is a transaction.
* **Dedalus**: MCP gateway wiring **vapi**, **agentmail**, **autumn**, **convex** (+ **browserâ€‘use** optional).
* **Vapi**: single outbound number with a scripted, bargeâ€‘inâ€‘capable flow.
* **Autumn**: create testâ€‘mode Stripe payment link; webhook (or poll) flips status.
* **AgentMail**: agentâ€™s own inbox to send the link and receive replies.

---

## Voice microâ€‘state machine (for clarity on narrative & QA)

(You said negotiation is handled; we still anchor the flow explicitly.)

**States:** Intro â†’ Verify â†’ Propose â†’ Negotiate â†’ Confirm â†’ Close
**Primary Outcome (for demo):** **PaidFull**
**Alternates prepared:** **PaidPartial**, **PromiseToPay**, **Unreachable** (fallback email), **Dispute**/**NotResponsible** (we will not steer here on stage).

**Trigger points into tools:**

* **Verify**: if verified name + invoice ID/amount, proceed; else fallback email only.
* **Confirm**: on acceptance, call **Autumn.createPaymentLink** (idempotent).
* **Close**: **AgentMail.send** with link; display trace; open link â†’ complete payment (test card).
* **Postâ€‘payment**: receive webhook or button to **â€œMark paid (webhook received)â€** if latency bites.

---

## Safety & determinism we will show explicitly

* **Guardrails card**: Allowed tools (vapi.call, agentmail.send, autumn.createPaymentLink, convex.transition). â€œPurchases: disabledâ€, â€œMax attempts/week: 2â€, â€œCall window: demo mode.â€
* **Trace**: Every tool call listed with timestamp and safe, humanâ€‘readable params.
* **Transactional state**: A badge flips only after a Convex mutation (â€œPaidâ€ appears with `txid`), never directly by the LLM.
* **Replayability**: â€œExport traceâ€ button (JSON) for auditors.

---

## Hourâ€‘byâ€‘hour plan (8 hours total)

### **H0 â†’ H+1 (11pmâ€“12am): Alignment & dry scaffolding**

* **Decide the demo path**: target **PaidFull**. Keep **PaidPartial** + **PromiseToPay** as live toggles in UI (hidden â€œforce pathâ€ if voice stalls).
* **Data freeze**: prepare 3 fake customers. Pick â€œAcme Co.â€ as the live one (amount \$1280, due 30 days ago).
* **Roles** (suggested):

  * **Lead / Demo** (you): runâ€‘ofâ€‘show owner, narration, judge Q\&A.
  * **Voice owner**: Vapi flow + fallback routing; stage audio.
  * **Payments owner**: Autumn/Stripe test mode + webhook/poll fallback; local manual â€œsimulate webhookâ€ button.
  * **UI/State owner**: Convex state wiring; counts, trace, guardrails, â€œReset demo.â€
  * **MCP owner**: Dedalus wiring; ensure tools appear in the trace with nice labels.

### **H+1 â†’ H+3 (12amâ€“2am): Tool wiring (happy path only)**

* **MCP gateway**: Register tools with humanâ€‘friendly names. Ensure **Trace** shows: â€œVapi.call( +1â€‘xxx ) â†’ Autumn.createPaymentLink(\$1280) â†’ AgentMail.send(to: [ar@acme.example](mailto:ar@acme.example)) â†’ Convex.transition( PaidFull ).â€
* **Vapi**:

  * Provision 1 outbound number.
  * Script tight flow: 5 lines max to PaidFull; bargeâ€‘in enabled; short pauses (set 0.2â€“0.4s).
  * Destination: teammateâ€™s phone (consenting â€œcustomerâ€) near the stage audio or WebRTC to laptop.
  * **Stage audio**: confirm how judges will hear the call (laptop speakers or small external speaker).
* **Autumn**:

  * Test keys; endpoint to create **Payment Link** for amount + memo (Invoice #, Acme Co.).
  * Confirm the link loads instantly in test mode; record the expected webhook/poll response shape.
  * **Manual â€œsimulate webhookâ€** UI button (adminâ€‘only) in case network chokes.
* **AgentMail**:

  * Create agent inbox (e.g., **collections\@agentmail**).
  * Template: brief, professional, includes the Autumn link, invoice details, and â€œpaid will autoâ€‘reflect in the portal.â€

### **H+3 â†’ H+5 (2amâ€“4am): UI that makes the story obvious**

* **Overdue board**: 3 cards, one highlighted â€œAcme Co.â€ with an **Overdue** badge. Counters at top.
* **Run panel**: split vertically â†’ **Trace** (top), **Guardrails** (right), **State path** (bottom). Each trace row clickable to show params.
* **Big button**: â€œStart Collections Run.â€ Clicking:

  1. Highlights Acme â†’ sets status **Inâ€‘Progress**.
  2. Pops **Guardrails** card.
  3. Streams **Trace** events live.
* **Inbox teaser**: small panel that shows the sent email in the agentâ€™s inbox (subject + link). Clicking opens it.
* **Reset** button: clears demo back to Overdue.
* **Polish**: timestamps in trace, a green confetti microâ€‘burst when â€œPaidâ€ lands.

### **H+5 â†’ H+6.5 (4amâ€“5:30am): Rehearsals & failure drills**

* **Dryâ€‘run 1 (full)**: Voice â†’ Payment link â†’ Pay with Stripe test card â†’ Webhook flips to **Paid**, counters update. Aim for **60â€“75 seconds**.
* **Dryâ€‘run 2 (latency)**: If webhook >10s, use **simulate** button at **T+8s**; update â€œwebhook pendingâ€ badge to â€œreconciled.â€
* **Dryâ€‘run 3 (voice fails)**: Skip to â€œUnreachableâ€ â†’ autoâ€‘send email â†’ click link â†’ pay â†’ state flips.
* **Dryâ€‘run 4 (wifi blip)**: Load link on phone hotspot; if still bad, click **simulate paid** after showing link.

### **H+6.5 â†’ H+7.5 (5:30amâ€“6:30am): Demo script & visuals**

* **Narration (90 seconds total)** (youâ€™ll memorize this):

  1. *â€œThis replaces an AR clerkâ€™s weekly chase.â€*
  2. Point to **Guardrails**: *â€œAllowed tools only, no surprises.â€*
  3. Click **Start Collections Run** â†’ call audio begins.
  4. When â€œConfirmedâ€, say: *â€œWatch the toolgraph: payment link created â†’ email sent â†’ state flips only on a transaction.â€*
  5. Open email â†’ click link â†’ pay (test card) â†’ back to dashboard shows **Paid**.
  6. *â€œInbox â†’ Cash. MCP tools, reactive state, transactional auditâ€”job replaced.â€*
* **Slide (oneâ€‘pager)** behind the demo: logo + four logos (**Vapi / AgentMail / Autumn / Convex**) + a tiny architecture diagram.
* **Q\&A crib sheet**: prepared answers (see â€œJudge landminesâ€ below).

### **H+7.5 â†’ H+8 (6:30amâ€“7:00am): Submission & buffer**

* **Submission assets**: 45â€“60s screen recording of the run, a diagram image, and a README (how to reproduce with sponsor credits).
* **Backup laptop/phone** with everything logged in.
* **Hydrate & 10â€‘min rest.**

---

## Runâ€‘ofâ€‘show details (what happens on stage)

1. **Preâ€‘show**: youâ€™re on the **Overdue board**. â€œAcme Co., \$1,280, 30 days overdue.â€
2. **Guardrails flash** (2 seconds): â€œAllowed tools; no purchases; attempts/week: 2.â€
3. **Start Collections Run** â†’ voice call begins (we hear it).
4. **Trace** updates: `Vapi.call â†’ Autumn.createPaymentLink($1280) â†’ AgentMail.send` (each with a âœ… when done).
5. **Open Inbox** â†’ open the email â†’ click **Payment Link**.
6. **Payment page** (test mode): enter test card quickly; submit.
7. **Dashboard**: counter flips; â€œAcme Co.â€ row turns **Paid**; spark of confetti.
8. **One line close**: *â€œWe turned an overdue invoice into cash in under 90 seconds, with a deterministic, auditable agent. This is your AR clerk, automated.â€*

---

## Fallbacks (decide now, so you donâ€™t hesitate)

* **Voice flaky?** Immediately: *â€œCustomer didnâ€™t pick upâ€”switching to email.â€* The agent emails the link; you click and pay.
* **Webhook slow?** After 8 seconds, click **â€œReconcile nowâ€** (admin simulate). Speak to it: *â€œWe reconcile webhooks periodically; reconciling now.â€*
* **Payment link down?** Show the email with the link visible; click **â€œSimulate paidâ€** after saying: *â€œStripe test mode is lagging; hereâ€™s the expected webhook result.â€*
* **Network dead?** Play the **45â€‘second screen recording** and narrate live; end on the actual dashboard showing Paid.

---

## â€œDonâ€™tâ€‘breakâ€‘thisâ€ checklist

* **Audio**: confirm the roomâ€™s output; test call volume; keep a small external speaker as backup.
* **Browser**: disable all extensions; set 100% zoom; preâ€‘open tabs in order; hotkeys off.
* **Credentials**: everything logged in; keep a notepad with the test card number & test email.
* **Reset path**: one click to â€œReset demo sta[<43;30;2M[<35;31;2Mteâ€ between rehearsals.
* **Time**: you should hit **Paid** by T+60s; never exceed **T+90s**.

---

## What each person does tonight (if you have 3â€“5 people)

**Lead / Demo (you)**

* Finalize narration; rehearse with timers.
* Own **Guardrails** copy and the closing line (â€œreplaces AR clerkâ€).
* Coordinate fallbacks; keep the simulateâ€‘paid button location in muscle memory.

**Voice owner**

* Configure Vapi number, script, bargeâ€‘in; test PSTN/WebRTC; confirm audio path.
* Keep a teammateâ€™s phone as the receiving â€œcustomer.â€
* Build a â€œswitch to emailâ€ branch if call fails within 5s.

**Payments owner**

* Autumn keys; ensure link opens instantly; prep test card info.
* Wire webhook or polling; add â€œsimulate paidâ€ admin action.
* Validate the memo includes invoice ID/amount.

**UI/State owner**

* Counters, highlights, trace list, guardrails card, **Paid** confetti.
* Reset button; â€œwebhook pendingâ€ badge; reconcile now button.
* Polished â€œAuditâ€ modal with readable trace lines.

**MCP owner**

* Dedalus registry; humanâ€‘readable tool names; trace JSON shaping.
* Confirm that only allowed tools are accessible during the run.

*(If youâ€™re a smaller team, collapse MCP+UI under one person.)*

---

## Judge landmines (and your crisp answers)

* **â€œIsnâ€™t this just a wrapper?â€**
  *Weâ€™re not a wrapper; weâ€™re a vertical agent that **owns AR**, with a typed, deterministic backend. The agent canâ€™t mutate state outside of transactional functions; every action is traced and replayable. Thatâ€™s job replacement, not a chat ma[<35;32;3M[<35;33;3Mcro.*

* **â€œHowâ€™s this better than a call center?â€**
  *Latency and consistency: the agent follows a microâ€‘state machine with clear guardrails; it never forgets followâ€‘ups, works 24/7, and integrates payments inline. Humans handle edge disputes; the agent handles 80% of the volume.*

* **â€œWhat breaks in the wild?â€**
  *Bad numbers, disputes, and portals. We handle those with outcome branches (**Unreachable**, **Dispute**) and put humans in the loop. Everything else stays automatedâ€”and audited.*

* **â€œWhy these tools?â€**
  *MCP lets us compose bestâ€‘inâ€‘class tools: Vapi for voice, AgentMail for inbox, Autumn for payments, Convex for state. Clean surfaces, clean trace.*

* **â€œWhatâ€™s next?â€**
  *Escalation cadence, multiâ€‘channel sequences, promiseâ€‘toâ€‘pay reminde[<35;34;4Mrs, portal scraping via Kernel, and portfolio analytics (recovery rate, daysâ€‘salesâ€‘outstanding).*

---

## Submission assets (lightweight)

* **60â€‘sec video**: Overdue â†’ call â†’ link â†’ Paid.
* **Diagram**: tiny toolgraph and dataflow.
* **README**: 1â€‘pager â€œHow it worksâ€ + sponsor credits + safety/guardrails.
* **Live URL**: with a demo reset route.

---

## Final advice for the room

* Keep the **trace** frontâ€‘andâ€‘centerâ€”judges love seeing tool calls roll in with parameters.
* Say the **jobâ€‘replacement** line confidently.
* Donâ€™t dwell on scheduling or generality. Weâ€™re vertical; we collect cash.
* Hit **Paid** within **60â€“75 seconds** if at all possible; youâ€™ll feel the room lean in.

If you want, after this planning pass I can write the **exact UI copy** f[<35;35;5Mor guardrails, trace rows, email template, and the 90â€‘sec narration so you can paste them in verbatim.


---
# Demo
Fantastic choice. Hereâ€™s a **tight, judgeâ€‘magnetic demo** for the AR Collections Agent that is fast, reliable, and shows undeniable value (â€œinbox â†’ cashâ€) while highlighting MCP, realâ€‘time state, and voice latency.

---

## What â€œbestâ€ looks like (success criteria)

* **A single, valuable outcome live on stage:** one overdue invoice goes from **Overdue â†’ Paid** in under **90 seconds**.
* **Clear job replacement:** you explicitly say â€œthis replaces an AR clerkâ€™s weekly chase.â€
* **Sponsorâ€‘aligned tech on screen:** MCP tool calls (Browser automation optional), **voice** (Vapi), **agent inbox** (AgentMail), **payment link** (Autumn/Stripe test mode), **reactive state** (Convex).
* **Determinism & safety:** visible guardrails, transactional state updates, full trace/audit.

---

## 4â€‘minute runâ€‘ofâ€‘show (tight script + visuals)

**0:00 â€“ 0:20 Â· Hook**

* You (confident, brisk):
  â€œEvery founder wastes Friday afternoons chasing invoices. Our **AR Collections Agent** does it for you: it **calls**, **emails**, sends a **payment link**, and updates your books. Watch **Overdue â†’ Paid** happen live.â€

**0:20 â€“ 0:40 Â· Zeroâ€‘state**

* Show a clean dashboard:

  * Counters: **Overdue: 6 Â· Inâ€‘Progress: 0 Â· Paid: 0**
  * 3â€‘column board: Overdue / Inâ€‘Progress / Paid
  * A small â€œMCP Tools activeâ€ badge (Voice, AgentMail, Payments, Convex)
  * Click an invoice row (e.g., â€œAcme Co â€” \$1,240 â€” 21 days lateâ€) â†’ side panel opens with **Plan**.

**0:40 â€“ 1:00 Â· Plan & guardrails**

* Plan panel shows:

  * Channel order: **Voice â†’ Email** (fallbacks if no answer)
  * Guardrails: â€œMax 2 attempts/week; identify as AR team; **never** take card over phone; only send secure linkâ€
  * â€œTone: cordial â†’ firm if >30 daysâ€
  * Button: **Call now**
* You (one line):
  â€œPlans are compiled and stored; guardrails make it safe and repeatable.â€

**1:00 â€“ 2:05 Â· Live call (the â€˜wowâ€™ moment)**

* Click **Call now** (speaker volume up).
  Agent: â€œHi, this is the AR team at **YourCo** calling about invoice 1043 for **\$1,240**, due July 31. Can you take care of it today?â€
  Human (your teammate in the audience): â€œI can do **\$600 today**, **rest Friday**.â€
  Agent: â€œGreat. Iâ€™ll send a secure link for **\$600** now and schedule the **\$640** balance for Friday. Shall I email it to **[payables@acme.test](mailto:payables@acme.test)**?â€
  Human: â€œYes.â€
  Agent: â€œThanks! Iâ€™ll text a confirmation too. Bye.â€

* On the dashboard, a **latency badge** (ms) ticks during the call; the **timeline** streams events live:

  * `CALL_CONNECTED`
  * `NEGOTIATED_PARTIAL_PAYMENT (600 today, 640 Friday)`
  * `CREATE_PAYMENT_LINK(600)`
  * `SEND_EMAIL(invoice_1043_link)`

**2:05 â€“ 2:40 Â· Payment & state flip**

* You open the **AgentMail** outbox item (agentâ€‘owned address) showing the email with the payment button.
* On a side screen (or same), click the **test payment** link (Stripe test mode) â†’ success page appears.
* Back on the dashboard, counters animate: **Overdue: 5 Â· Inâ€‘Progress: 1 Â· Paid: 1**; the card moves to **Paid** with a badge â€œ\$600 today; \$640 scheduledâ€.

**2:40 â€“ 3:20 Â· Auditability & scheduling**

* Click **Trace**:

  * Show **MCP tool calls** with inputs/outputs (redact PII): Voice tool, Payment tool, AgentMail tool.
  * Show **Convex** state mutation logs (â€œNotified â†’ PromiseToPay â†’ PartialPaid â†’ Paid(Partial)â€).
* Toggle **Autoâ€‘followâ€‘up Friday 10am** (schedule created).
* One line for Jared:
  â€œThis is a **jobâ€‘replacing vertical agent**â€”collections done, auditâ€‘safe, schedulable.â€

**3:20 â€“ 4:00 Â· Close**

* Click **Blueprint** tab to show the saved playbook (tools, tone, guardrails).
* Final line:
  â€œIn 24 hours we shipped an AR agent that turns **inbox â†’ cash** with live voice, secure payments, and deterministic state. Itâ€™s not a promptâ€”itâ€™s a **blueprint** you run every week.â€

---

## Preparation (so it never breaks on stage)

**People & devices**

* One teammate as the â€œcustomerâ€ with a charged phone, in a quiet corner (or outside the room).
* Laptop on ethernet if possible; external speaker (or stage audio) for the call.

**Seed data (CSV)**

```
customer,contact_email,contact_phone,invoice_id,amount_due,due_date,days_late,notes
Acme Co,payables@acme.test,+1-415-555-0199,1043,1240,2025-07-31,21,Good payer; prefers partials
Bravo LLC,ar@bravo.test,+1-415-555-0123,1044,980,2025-08-01,20,Ask for Friday
...
```

**Accounts & config**

* **Voice:** provision a Vapi number; disable voicemail fallback; enable bargeâ€‘in; set initial prompt & slots (amount, dates, email).
* **Email:** create an **AgentMail** inbox (e.g., [ar@yourco.agent](mailto:ar@yourco.agent)).
* **Payments:** set Autumn/Stripe **test mode**; preâ€‘configure product/price; webhooks to mark `PartialPaid` or `Paid`.
* **State:** Convex project seeded with tables: `customers`, `invoices`, `attempts`, `payments`, `promises`. Basic transactional functions for state transitions.
* **Toggle â€œSimulateâ€:** a topâ€‘right switch that swaps the voice/payment tools for a simulator if Wiâ€‘Fi melts (preâ€‘recorded audio + local webhook).

**UI**

* **Top bar:** counters + latency badge.
* **Left:** Kanban columns.
* **Right drawer (selected invoice):** Plan/Guardrails, Call button, Timeline (streaming), Trace (MCP), Email preview.
* **Status chips:** Overdue (red), Inâ€‘Progress (amber), Paid (green).

---

## Exact demo lines (memorize these)

* â€œWeâ€™re automating ARâ€”not assisting it. **This replaces the weekly clerk work.**â€
* â€œEverything you see is **toolâ€‘backed via MCP**; every step is **audited** and **transactional**.â€
* â€œWe never take card details by phone; we only send **secure links**; **guardrails** enforce policy.â€
* â€œNote the **reactive UI**â€”the board flips the instant the payment posts.â€
* â€œThis is **not** a chat transcript. Itâ€™s a **versioned blueprint** you can run, fork, and schedule.â€

---

## Fallback decision tree (two clicks, no panic)

1. **Call doesnâ€™t connect (10s):**

   * Flip **Simulate**. Press **Play prerecorded call** (clean, the same dialog). Continue the demo; timeline shows tool events as if live.

2. **Payment link blocked / network shaky (10s):**

   * Click **Simulate payment** â†’ triggers the same webhook â†’ state flips to Paid; narrate â€œStripe test mode; live in the booth after.â€

3. **Email provider lagging:**

   * Show **AgentMail outbox** record and the **link preview** inside the UI; still click the link from the preview.

4. **General meltdown:**

   * Run the **90â€‘second screen recording** of a complete run; talk over it and then switch back to UI for Q\&A.

---

## Microâ€‘features that sell to these judges (add if time permits)

* **Latency chip** during the call (e.g., â€œvoice RTT: 420â€¯msâ€) to delight the voice judge.
* **Escalation rule** demo: if >30 days late â†’ tone shifts + email CC changes.
* **Preferences memory:** â€œAcme prefers calls after 10am PTâ€ autoâ€‘applied to scheduling.
* **Oneâ€‘click â€œPay fullâ€ vs â€œPartialâ€** in the email template; agent adapts copy accordingly.
* **Audit export** (JSON or CSV) of the run (inputs/outputs/trace).

---

## What to hand in with the demo (submission package)

* **Live URL** with seeded demo data + Simulate toggle.
* **90â€‘second capture video** of a perfect run.
* **README**: architecture diagram, tool list, and one paragraph on determinism/guardrails.
* **Appendix**: blueprint JSON (tools, guardrails, tone), plus a single screenshot of the MCP trace.

---

If you want me to, I can also give you:

* the blueprint fields to persist,
* the minimal Convex schema (tables + transitions),
* a concise voice prompt/callâ€‘flow for Vapi,
* and the email templates (subject/body) tuned to be cordialâ€‘thenâ€‘firm.

But the plan above is the **best possible** 4â€‘minute demo: one click, one call, one payment, **job replaced**â€”and everything on screen is auditable, reactive, and MCPâ€‘powered.


---
## negotiation:
Short version: **Yesâ€”handle negotiation and guardrails explicitly.** It makes the agent look *professional, safe, and productionâ€‘ready*, which is exactly what these judges reward. You donâ€™t need full regulatory coverage for a hackathon, but you should implement a **minimal, visible policy layer** that (1) shapes negotiation behavior, (2) blocks risky actions, and (3) leaves an auditable trail.

Below is a complete, copyâ€‘pasteable spec: conversation flow, policy/guardrails, tool contracts, and the exact Vapi call design.

---

## A. What the negotiation *is* (behavioral blueprint)

Think of negotiation as a tiny state machine with a rubric, not freeâ€‘chat.

**States:** `Intro â†’ Verify â†’ Propose â†’ Negotiate â†’ Confirm â†’ Close`
**Outcomes:** `PaidFull | PaidPartial | PromiseToPay | Dispute | NotResponsible | Unreachable`

**Rubric (laddered):**

1. **Intro + identity & purpose**

   * â€œHi, this is **<AgentName>** with **<YourCo AR>**. Calling about invoice **#1043** for **\$1,240**, due **July 31**.â€

2. **Verify**

   * â€œAm I speaking with someone who can handle payment for **Acme Co**?â€
   * If not responsible â†’ collect responsible contact â†’ **Close**.

3. **Propose (default ask)**

   * â€œCan you take care of the full **\$1,240** today?â€
   * If **yes** â†’ **Confirm** (email for secure link) â†’ **Close** (PaidFull after link).

4. **Negotiate (bounded offers)**

   * If **no**, ask constraints: â€œWhatâ€™s feasible today?â€
   * Offer **bounded options** from policy:

     * **Partial today â‰¥ `minPartialPct`** (e.g., â‰¥ 40%) + remainder by **`maxDaysToSettle`** (e.g., 14 days).
     * Or **dated PromiseToPay** if zero today is allowed by policy and **daysLate < threshold**.
   * If customer proposes terms, **validate** against policy; if outâ€‘ofâ€‘bounds â†’ counter within bounds or **escalate to human**.

5. **Confirm**

   * Recap exact plan: â€œConfirming: **\$600 today** by secure link, **\$640 Friday Aug 29** by followâ€‘up link. Email to **[payables@acme.test](mailto:payables@acme.test)**â€”is that right?â€
   * Never collect card details over phone. Always send link.

6. **Close**

   * â€œThanks. Sending the secure link now. Youâ€™ll also get a confirmation email. Have a great day.â€

**Fallbacks/branches to handle cleanly:**

* **Already paid:** apologize, request proof (screenshot or remittance), mark `UnderReview`, escalate.
* **Dispute amount/service:** stop negotiating money; mark `Dispute`, escalate to human.
* **Not the right person:** capture new contact; schedule call; mark `Reassign`.
* **Busy:** schedule a specific callback time; mark `Callback`.
* **No answer / voicemail:** one concise voicemail + email; increment attempt counter; respect frequency guardrail.

---

## B. Guardrails you **should** handle (hackathonâ€‘minimal, highâ€‘impact)

Youâ€™re not doing legal advice here; youâ€™re showing you thought about **safety**. Implement these visibly:

1. **Identity & transparency** â€“ always state youâ€™re **<YourCo> AR**, never misrepresent.
2. **No card numbers on calls** â€“ only **secure payment links**; redact any volunteered sensitive info.
3. **Contact windows** â€“ call only between **08:00â€“21:00 local** (override for demo with a â€œdemo modeâ€ toggle).
4. **Attempt frequency** â€“ max **2 attempts/week** per contact; honor **doâ€‘notâ€‘call** flags.
5. **Tone & language** â€“ cordial â†’ firm after **`firmDaysLate`**; never threaten or imply legal action.
6. **Escalation conditions** â€“ disputes, fraud suspicion, outâ€‘ofâ€‘policy requests, or repeated refusals.
7. **PII minimization** â€“ confirm email verbally, donâ€™t read out addresses; mask in logs.
8. **Audit trail** â€“ log every tool call and state transition; store transcripts and artifacts.
9. **Optâ€‘out** â€“ if asked not to call, mark `DNC` immediately and switch to emailâ€‘only or cease contact per policy.
10. **Partial payment policy** â€“ hard limits (`minPartialPct`, `maxInstallments`, `maxDaysToSettle`) enforced serverâ€‘side.

These are easy to *show* in the UI as a â€œPolicyâ€ card and to enforce programmatically.

---

## C. Where guardrails live (three enforcement layers)

1. **Promptâ€‘level constraints (voice agent â€œsystemâ€ prompt):**
   Describe role, tone, and *hard rules it must not break* (no card collection, offer bounds, escalation triggers).

2. **Toolâ€‘gating (capabilities):**
   The only way to take action is via whitelisted tools: `createPaymentLink`, `sendEmail`, `scheduleFollowUp`, `updateInvoiceStatus`. If a tool isnâ€™t exposed, the agent simply canâ€™t do dangerous things.

3. **Runtime policy check (server):**
   Every tool call goes through `Policy.check(request, customerContext)` before executing. If it violates rules (time window, frequency, amounts), the server returns a *policy error*; the agent must offer a compliant alternative or escalate.

---

## D. Concrete â€œPolicy DSLâ€ (editable in UI)

Keep it simple and typed. Example:

```yaml
name: default_ar_policy_v1
contact_window:
  start_local: "08:00"
  end_local: "21:00"
attempt_limits:
  max_attempts_per_week: 2
  max_voicemails_per_week: 1
payment_rules:
  min_partial_pct: 0.40          # 40% minimum today
  max_installments: 2
  max_days_to_settle: 14
  allow_zero_today_if_days_late_lt: 15
tone_rules:
  firm_after_days_late: 30
  profanity_block: true
escalation_triggers:
  - dispute
  - fraud_suspected
  - out_of_policy_offer
  - do_not_call
prohibited_actions:
  - collect_card_details
  - threaten_legal_action
```

---

## E. Minimal TypeScript types (so you can wire Convex now)

```ts
type InvoiceState = "Overdue" | "InProgress" | "PromiseToPay" | "PartialPaid" | "Paid" | "Dispute" | "Reassign" | "Callback" | "DNC";

interface Policy {
  id: string;
  contactWindow: { startLocal: string; endLocal: string };
  attemptLimits: { maxAttemptsPerWeek: number; maxVoicemailsPerWeek: number };
  paymentRules: { minPartialPct: number; maxInstallments: number; maxDaysToSettle: number; allowZeroTodayIfDaysLateLt: number };
  toneRules: { firmAfterDaysLate: number; profanityBlock: boolean };
  escalationTriggers: string[];
  prohibitedActions: string[];
}

interface NegotiationPlan {
  askFull: boolean;
  allowPartial: boolean;
  minPartialPct: number;
  maxDaysToSettle: number;
  maxInstallments: number;
}

interface ToolCall<T=any> { tool: string; input: T; time: number; status: "ok" | "blocked" | "error"; policyMsg?: string; }

interface RunTrace {
  runId: string;
  invoiceId: string;
  events: ToolCall[];
}
```

**Convex function example (policyâ€‘enforced):**

```ts
export const createPaymentLink = mutation({
  args: { invoiceId: v.string(), amount: v.number(), dueDate: v.optional(v.string()) },
  handler: async (ctx, args) => {
    const inv = await ctx.db.get(invoiceId);
    const policy = await ctx.db.get("policy", inv.policyId);
    if (args.amount < inv.total * policy.paymentRules.minPartialPct) {
      return { status: "blocked", reason: "Below min partial %" };
    }
    // ...call Autumn/Stripe test-mode...
    // ...write Payment + RunTrace...
    return { status: "ok", link: "<test-link>" };
  }
});
```

---

## F. Vapi call design (voice agent)

**System prompt (core):**

> â€œYou are **<YourCo AR>**, calling about overdue invoices. Always:
>
> 1. State identity and purpose clearly.
> 2. Verify youâ€™re speaking with the responsible party.
> 3. First ask for full payment today via **secure link** (never collect card details).
> 4. If full isnâ€™t feasible, negotiate **within these bounds**:
>    â€“ Minimum partial today: **40%**
>    â€“ Max installments: **2**, settle within **14 days**
>    â€“ If days late < **15**, allow promiseâ€‘toâ€‘pay with a specific date.
> 5. If terms requested are out of bounds, offer the closest allowed option or **escalate to a human**.
> 6. Confirm email, summarize the plan, and end courteously.
>    Never threaten, never discuss legal action, and comply with doâ€‘notâ€‘call. If a dispute arises, stop and escalate.â€

**Slots (what the voice agent must extract):**

* `can_pay_full_today: boolean`
* `partial_amount_today: number`
* `promise_date: ISODate`
* `installments: 1|2`
* `confirm_email: string`
* `callback_time: string`
* `notes: string` (freeform constraints)

**Tool calls exposed to the voice agent (via MCP / webhook):**

* `createPaymentLink({invoiceId, amount, dueDate?}) â†’ {status, link}`
* `sendEmail({to, subject, body, link}) â†’ {status}`
* `updateInvoiceStatus({invoiceId, state, meta}) â†’ {status}`
* `scheduleFollowUp({invoiceId, at, channel}) â†’ {status}`

*(Every call is policyâ€‘checked serverâ€‘side. If blocked, return `{status:"blocked", reason}` and the voice agent apologizes and offers a compliant plan.)*

**Example negotiation (partial today):**

Agent: â€œHi, this is **Sam with YourCo AR** calling about invoice **#1043** for **\$1,240**, due **July 31**. Can you take care of it today?â€
Customer: â€œNot the full amount.â€
Agent: â€œUnderstood. Whatâ€™s feasible today?â€
Customer: â€œ**\$600** today, rest Friday.â€
Agent: â€œThat works. Iâ€™ll send a secure link for **\$600** now and a followâ€‘up link for **\$640** on **Friday Aug 29**. Should I email **[payables@acme.test](mailto:payables@acme.test)**?â€
Customer: â€œYes.â€
Agent: â€œGreatâ€”sending now. Youâ€™ll receive a confirmation email. Thanks!â€

*(Behind the scenes: `createPaymentLink(600)` â†’ ok â†’ `sendEmail(...)` â†’ ok â†’ `updateInvoiceStatus(PartialPaid, {today:600, remaining:640, date:'2025â€‘08â€‘29'})`.)*

**Outâ€‘ofâ€‘policy example:**

Customer: â€œI can do **\$200** today, rest in three payments.â€
Agent: â€œOur policy requires at least **40%** today and settling within **14 days**. I can accept **\$496 today** and **\$744 Friday**. Would that work? If not, Iâ€™ll loop in a teammate who can approve exceptions.â€

---

## G. UI surfaces that make this obvious to judges

* **Policy chip** on the right drawer: shows current bounds (min partial, max installments, contact window, attempts/week).
* **Guardrail banner** during call: â€œNo card collection â€¢ Attempts left this week: 1 â€¢ Local time: 10:42 AM (OK)â€
* **Trace tab**: each tool call shows `status: ok/blocked` and the reason if blocked.
* **Edit Policy** button (readâ€‘only in demo) to prove itâ€™s configurable.

---

## H. Do you *have to* handle this now?

* **Yes for the demo:** implement the **minimal guardrails above** and show them in UI. Itâ€™s low effort and high signal.
* **No for full compliance tonight:** donâ€™t promise regulatory completeness. Label the policy card â€œDemo policy (firstâ€‘party AR)â€ and include a oneâ€‘liner: â€œFor production, add jurisdictionâ€‘specific rules; we never take card details; disputes escalate.â€

**Minimum to ship tonight (checklist):**

* [ ] Prompt includes rules + bounds
* [ ] Only safe tools exposed
* [ ] Serverâ€‘side `Policy.check` gates every tool call
* [ ] Contact window + attempt counter enforced
* [ ] Doâ€‘notâ€‘call flag respected
* [ ] No card collection path exists anywhere
* [ ] Trace & state transitions persisted

---

If you want, I can draft:

* the exact **Vapi system prompt** and slot schema,
* a **Convex mutation** for each tool with policy checks,
* and a **1â€‘page policy editor** (readâ€‘only) so judges see guardrails at a glance.

But with the spec above, you can implement negotiation + guardrails in a few focused hours and look *productionâ€‘minded* on stage.

